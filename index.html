<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸°å‚å±Šã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --main-red: #e74c3c; --line-green: #06C755; }
        body { font-family: sans-serif; background: #f4f7f6; padding: 15px; margin: 0; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; font-size: 2.2rem; margin-bottom: 20px; color: #333; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.9rem; }
        .req { color: red; margin-left: 5px; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .flex-row { display: flex; gap: 10px; align-items: center; }
        .flex-row div { flex: 1; }
        .red-box { border: 2px solid var(--main-red); padding: 15px; border-radius: 8px; margin-top: 20px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .btn-confirm { background: #34495e; color: white; }
        .btn-line { background: var(--line-green); color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 0.9rem; }
        th { background: #eee; }
        input[type="number"] { text-align: center; border: none; background: transparent; width: 100%; height: 100%; }
        #confirmPage { display: none; }
        .hidden { display: none; }
        #captureArea { background: white; padding: 20px; }
        .total-badge { background: #eee; padding: 5px 10px; border-radius: 5px; font-size: 0.9rem; margin-top: 5px; display: inline-block; }
    </style>
</head>
<body>

<div id="inputPage" class="container">
    <h1>å¸°å‚å±Š</h1>
    
    <label>æ•™ä¼šåï¼ˆå›£ä½“åï¼‰<span class="req">*</span></label>
    <input type="text" id="church">

    <label>å¸°å‚è€…åï¼ˆä»£è¡¨ï¼‰<span class="req">*</span></label>
    <input type="text" id="repName">

    <label>é€£çµ¡å…ˆ<span class="req">*</span></label>
    <input type="tel" id="tel" placeholder="090-0000-0000">

    <label>äººæ•°ï¼ˆå¤§äººãƒ»å­ä¾›ãƒ»ä¹³å…ï¼‰</label>
    <div class="flex-row">
        <div><small>å¤§äºº</small><input type="number" id="pAdult" oninput="calcTotal()"></div>
        <div><small>å­ä¾›</small><input type="number" id="pChild" oninput="calcTotal()"></div>
        <div><small>ä¹³å…</small><input type="number" id="pBaby" oninput="calcTotal()"></div>
    </div>
    <div id="totalDisplay" class="total-badge">åˆè¨ˆï¼š0å</div>

    <label>è©°æ‰€åˆ°ç€æ—¥æ™‚<span class="req">*</span></label>
    <div class="flex-row">
        <input type="date" id="arrDate" onchange="generateMealTable()">
        <input type="time" id="arrTime">
    </div>
    <label>è©°æ‰€å‡ºç™ºæ—¥æ™‚<span class="req">*</span></label>
    <div class="flex-row">
        <input type="date" id="depDate" onchange="generateMealTable()">
        <input type="time" id="depTime">
    </div>

    <label>äº¤é€šæ‰‹æ®µ</label>
    <select id="transportMain" onchange="toggleTransport()">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="å…¬å…±äº¤é€š">å…¬å…±äº¤é€š</option>
        <option value="ç‹¬è‡ª">ç‹¬è‡ª</option>
    </select>
    <div id="transSubArea" class="hidden"><select id="transportSub" onchange="toggleCarNum()" style="margin-top:10px;"></select></div>
    <div id="carNumArea" class="hidden"><label>è‡ªå®¶ç”¨è»Š å°æ•°</label><input type="number" id="carNum"></div>

    <h2>é£Ÿäº‹ãƒ»å®¿æ³Š</h2>
    <div id="dateList">æ—¥ä»˜ã‚’å…¥åŠ›ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™</div>

    <div class="red-box">
        <h3 style="color:red; margin:0 0 10px;">ç›´å±é£Ÿåˆ¸ç”³è¾¼</h3>
        <div class="flex-row">
            <div><small>æ—¥ä»˜</small><input type="date" id="ticketDate"></div>
            <div><small>é£Ÿæ•°</small><input type="number" id="ticketCount"></div>
        </div>
    </div>

    <label>å‚™è€ƒ</label>
    <textarea id="memo" rows="3" placeholder="å¥³æ€§éƒ¨å±‹å¸Œæœ›ç­‰ã‚ã‚Šã¾ã—ãŸã‚‰ã”è¨˜å…¥ä¸‹ã•ã„ã€‚"></textarea>

    <button class="btn btn-confirm" onclick="showConfirm()">ç¢ºèªãƒšãƒ¼ã‚¸ã¸</button>
</div>

<div id="confirmPage" class="container">
    <div id="captureArea">
        <h1 style="border-bottom: 3px solid #333; padding-bottom: 10px; text-align: center;">å¸°å‚å±Š</h1>
        <div id="summaryTable"></div>
    </div>
    <div id="autoImageArea" style="text-align:center;"></div>
    <button class="btn btn-line" onclick="sendLine()">LINEã‚’é–‹ã</button>
    <button class="btn" onclick="goBack()" style="background:#ccc;">ä¿®æ­£ã™ã‚‹</button>
</div>

<script>
    function calcTotal() {
        const a = Number(document.getElementById('pAdult').value || 0);
        const c = Number(document.getElementById('pChild').value || 0);
        const b = Number(document.getElementById('pBaby').value || 0);
        document.getElementById('totalDisplay').innerText = `åˆè¨ˆï¼š${a + c + b}å`;
    }

    function toggleTransport() {
        const main = document.getElementById('transportMain').value;
        const sub = document.getElementById('transportSub');
        const subArea = document.getElementById('transSubArea');
        sub.innerHTML = '<option value="">è©³ç´°ã‚’é¸æŠ</option>';
        if (main === "å…¬å…±äº¤é€š") {
            subArea.classList.remove('hidden');
            ['é›»è»Š', 'ãƒã‚¹'].forEach(v => sub.innerHTML += `<option value="${v}">${v}</option>`);
        } else if (main === "ç‹¬è‡ª") {
            subArea.classList.remove('hidden');
            ['è¦³å…‰ãƒã‚¹', 'ãƒã‚¤ã‚¯ãƒ­ãƒã‚¹', 'è‡ªå®¶ç”¨è»Š', 'ä»–'].forEach(v => sub.innerHTML += `<option value="${v}">${v}</option>`);
        } else { subArea.classList.add('hidden'); }
        toggleCarNum();
    }

    function toggleCarNum() {
        const sub = document.getElementById('transportSub').value;
        const carArea = document.getElementById('carNumArea');
        if (sub === "è‡ªå®¶ç”¨è»Š") carArea.classList.remove('hidden');
        else carArea.classList.add('hidden');
    }

    function generateMealTable() {
        const s = document.getElementById('arrDate').value;
        const e = document.getElementById('depDate').value;
        if (!s || !e) return;
        const start = new Date(s); const end = new Date(e);
        let html = '<table><tr><th>æ—¥ä»˜</th><th>æœé£Ÿ</th><th>æ˜¼é£Ÿ</th><th>å¤•é£Ÿ</th><th>å®¿æ³Š</th></tr>';
        let curr = new Date(start);
        while (curr <= end) {
            const d = (curr.getMonth()+1) + '/' + curr.getDate();
            html += `<tr><td>${d}</td><td><input type="number" class="m-in"></td><td><input type="number" class="m-in"></td><td><input type="number" class="m-in"></td><td><input type="number" class="m-in"></td></tr>`;
            curr.setDate(curr.getDate() + 1);
        }
        document.getElementById('dateList').innerHTML = html + '</table>';
    }

    async function showConfirm() {
        const req = ['church', 'repName', 'tel', 'arrDate', 'depDate'];
        if (req.some(id => !document.getElementById(id).value)) { alert('å¿…é ˆé …ç›®ï¼ˆ*ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

        const a = Number(document.getElementById('pAdult').value || 0);
        const c = Number(document.getElementById('pChild').value || 0);
        const b = Number(document.getElementById('pBaby').value || 0);
        
        let mRows = "";
        document.querySelectorAll('#dateList tr').forEach((tr, i) => {
            if(i === 0) return;
            const v = Array.from(tr.querySelectorAll('input')).map(inp => inp.value || "0");
            mRows += `<tr><td>${tr.cells[0].innerText}</td><td>${v[0]}</td><td>${v[1]}</td><td>${v[2]}</td><td>${v[3]}</td></tr>`;
        });

        const carStr = document.getElementById('transportSub').value === "è‡ªå®¶ç”¨è»Š" ? ` (${document.getElementById('carNum').value}å°)` : "";

        document.getElementById('summaryTable').innerHTML = `
            <table>
                <tr><th>æ•™ä¼šå</th><td>${document.getElementById('church').value}</td></tr>
                <tr><th>ä»£è¡¨è€…</th><td>${document.getElementById('repName').value}</td></tr>
                <tr><th>é€£çµ¡å…ˆ</th><td>${document.getElementById('tel').value}</td></tr>
                <tr><th>åˆè¨ˆäººæ•°</th><td>${a+c+b}å (å¤§${a}/å­${c}/ä¹³${b})</td></tr>
                <tr><th>åˆ°ç€</th><td>${document.getElementById('arrDate').value} ${document.getElementById('arrTime').value}</td></tr>
                <tr><th>å‡ºç™º</th><td>${document.getElementById('depDate').value} ${document.getElementById('depTime').value}</td></tr>
                <tr><th>äº¤é€šæ‰‹æ®µ</th><td>${document.getElementById('transportMain').value}-${document.getElementById('transportSub').value}${carStr}</td></tr>
            </table>
            <h4 style="margin:15px 0 5px;">ã€é£Ÿäº‹ãƒ»å®¿æ³Šæ˜ç´°ã€‘</h4>
            <table><tr><th>æ—¥ä»˜</th><th>æœé£Ÿ</th><th>æ˜¼é£Ÿ</th><th>å¤•é£Ÿ</th><th>å®¿æ³Š</th></tr>${mRows}</table>
            <p style="color:red; font-weight:bold; margin-top:10px; border:1px solid red; padding:5px;">ç›´å±é£Ÿåˆ¸: ${document.getElementById('ticketDate').value} / ${document.getElementById('ticketCount').value}æš</p>
            <p style="text-align:left; font-size:0.9rem; margin-top:10px;">å‚™è€ƒ: ${document.getElementById('memo').value}</p>
        `;

        document.getElementById('inputPage').style.display = 'none';
        document.getElementById('confirmPage').style.display = 'block';
        window.scrollTo(0,0);

        // ç¢ºèªç”»é¢ã‚’ç”»åƒåŒ–
        const area = document.getElementById('captureArea');
        const canvas = await html2canvas(area, {scale: 2});
        const imgTag = document.createElement('img');
        imgTag.src = canvas.toDataURL("image/png");
        imgTag.style.width = "100%";
        imgTag.style.border = "2px solid #333";
        const target = document.getElementById('autoImageArea');
        target.innerHTML = "<p style='color:orange; font-weight:bold;'>ğŸ‘‡ã“ã®ç”»åƒã‚’ä¿å­˜ã¾ãŸã¯ã‚¹ã‚¯ã‚·ãƒ§</p>";
        target.appendChild(imgTag);
    }

    function goBack() {
        document.getElementById('confirmPage').style.display = 'none';
        document.getElementById('inputPage').style.display = 'block';
    }

    function sendLine() {
        window.location.href = `https://line.me/R/share?text=${encodeURIComponent("å¸°å‚å±Šã‚’é€ä¿¡ã—ã¾ã™ã€‚ç”»åƒã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚")}`;
    }
</script>
</body>
</html>
